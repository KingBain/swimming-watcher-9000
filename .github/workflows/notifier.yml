name: Ping and Parse API

on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry Run: Query the live API and send a WhatsApp message with the statistics.'
        required: true
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  ping_and_notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send POST request
        id: send_request
        run: |
          API_URL="https://anc.ca.apm.activecommunities.com/ottawa/rest/activities/list?locale=en-US"

          # Dynamically get today's date
          TODAY=$(date +"%Y-%m-%d")

          # Use a heredoc to safely store the complex JSON payload
          POST_DATA=$(cat <<EOF_POST
          {
            "activity_search_pattern": {
              "skills": [],
              "time_after_str": "",
              "days_of_week": "",
              "activity_select_param": 0,
              "center_ids": ["327"],
              "time_before_str": "",
              "open_spots": null,
              "activity_id": null,
              "activity_category_ids": [],
              "date_before": "",
              "min_age": null,
              "date_after": "$TODAY",
              "activity_type_ids": [],
              "site_ids": [],
              "for_map": false,
              "geographic_area_ids": [],
              "season_ids": [],
              "activity_department_ids": [],
              "activity_other_category_ids": [],
              "child_season_ids": [],
              "activity_keyword": "Swim Colours 5 â€“ Purple (low ratio)",
              "instructor_ids": [],
              "max_age": null,
              "custom_price_from": "",
              "custom_price_to": ""
            },
            "activity_transfer_pattern": {}
          }
          EOF_POST
          )

          # Send request: Output body to api_response.json and capture only the HTTP status code
          HTTP_STATUS=$(curl -s -o api_response.json -w "%{http_code}" -X POST -H "Content-Type: application/json" -d "$POST_DATA" "$API_URL")

          # Save ONLY the HTTP Status to environment variables
          echo "HTTP_STATUS=$HTTP_STATUS" >> "$GITHUB_ENV"

      - name: Parse response and output stats
        id: parse_response
        run: |
          # 1. Check if the API call was successful
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "âŒ Error: API returned HTTP $HTTP_STATUS"
            cat api_response.json
            exit 1
          fi

          # 2. Calculate statistics strictly and safely
          TOTAL_CLASSES=$(jq -r '.body.activity_items // [] | length' api_response.json)
          OPEN_CLASSES=$(jq -r '[.body.activity_items // [] | .[] | select((.total_open // 0) > (.already_enrolled // 0))] | length' api_response.json)

          TOTAL_CLASSES=${TOTAL_CLASSES:-0}
          OPEN_CLASSES=${OPEN_CLASSES:-0}
          FULL_CLASSES=$((TOTAL_CLASSES - OPEN_CLASSES))

          # 3. Print the statistics table to the GitHub Actions Console
          echo "ðŸ“Š API Response Statistics:"
          echo "-----------------------------------"
          echo "HTTP Response Code    : $HTTP_STATUS"
          echo "Total Classes Found   : $TOTAL_CLASSES"
          echo "Classes Full          : $FULL_CLASSES"
          echo "Classes with Openings : $OPEN_CLASSES"
          echo "-----------------------------------"

          if [ "$OPEN_CLASSES" -eq 0 ] && [ "$TOTAL_CLASSES" -gt 0 ]; then
            echo "All classes are currently full."
          elif [ "$TOTAL_CLASSES" -eq 0 ]; then
            echo "âš ï¸ No classes matched the search criteria."
            echo "--- RAW API RESPONSE FOR DEBUGGING ---"
            jq . api_response.json || cat api_response.json
            echo "--------------------------------------"
          fi

          # Output variables for next steps
          echo "total_classes=$TOTAL_CLASSES" >> "$GITHUB_OUTPUT"
          echo "full_classes=$FULL_CLASSES" >> "$GITHUB_OUTPUT"
          echo "open_classes=$OPEN_CLASSES" >> "$GITHUB_OUTPUT"

      - name: Update README with latest status
        run: |
          UPDATED_AT=$(date -u +"%Y-%m-%d %H:%M UTC")

          if [ "${{ steps.parse_response.outputs.open_classes }}" -gt 0 ]; then
            AVAILABILITY_STATUS="ðŸŸ¢ Open spots available"
          elif [ "${{ steps.parse_response.outputs.total_classes }}" -gt 0 ]; then
            AVAILABILITY_STATUS="ðŸŸ¡ No open spots (all classes full)"
          else
            AVAILABILITY_STATUS="ðŸ”´ No matching classes found"
          fi

          AVAILABILITY_BLOCK=$(cat <<EOF_BLOCK
          <!-- availability:start -->
          _Last updated: $UPDATED_AT_

          - HTTP Status: $HTTP_STATUS
          - Total classes: ${{ steps.parse_response.outputs.total_classes }}
          - Full classes: ${{ steps.parse_response.outputs.full_classes }}
          - Classes with openings: ${{ steps.parse_response.outputs.open_classes }}
          - Status: $AVAILABILITY_STATUS
          <!-- availability:end -->
          EOF_BLOCK
          )

          awk -v replacement="$AVAILABILITY_BLOCK" '
            /<!-- availability:start -->/ {
              print replacement
              skip=1
              next
            }
            /<!-- availability:end -->/ {
              skip=0
              next
            }
            !skip { print }
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Commit README updates
        run: |
          if git diff --quiet README.md; then
            echo "No README changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore: update swim availability snapshot"
          git push

      - name: Send Dry Run Statistics (Manual Trigger)
        if: inputs.dry_run == true
        run: |
          # Message formatted for WhatsApp readability
          MESSAGE=$(printf "ðŸ“Š *API Health Check*\n*Total Classes:* %s\n*Full:* %s\n*Openings:* %s" \
            "${{ steps.parse_response.outputs.total_classes }}" \
            "${{ steps.parse_response.outputs.full_classes }}" \
            "${{ steps.parse_response.outputs.open_classes }}")

          echo -e "Sending Dry Run message:\n$MESSAGE\n---"

          ENCODED_MESSAGE=$(echo "$MESSAGE" | jq -sRr @uri)

          # Fire the CallMeBot API Call
          curl -s -X GET "https://api.callmebot.com/whatsapp.php?phone=${{ secrets.WHATSAPP_PHONE_NUMBER_NOTIFY }}&text=${ENCODED_MESSAGE}&apikey=${{ secrets.CALLMEBOT_APIKEY }}"

      - name: Parse and send messages for available activities
        if: steps.parse_response.outputs.open_classes > 0
        run: |
          # Loop strictly through items where capacity > enrolled
          jq -c '.body.activity_items // [] | .[] | select((.total_open // 0) > (.already_enrolled // 0))' api_response.json | while read -r i; do
            NAME=$(echo "$i" | jq -r '.name')
            DOW=$(echo "$i" | jq -r '.days_of_week')
            DATES=$(echo "$i" | jq -r '.date_range')
            TIME=$(echo "$i" | jq -r '.time_range')
            DETAIL_URL=$(echo "$i" | jq -r '.detail_url')

            # Calculate exactly how many spots are left
            SPOTS_LEFT=$(echo "$i" | jq -r '(.total_open // 0) - (.already_enrolled // 0)')

            # Message formatted for WhatsApp readability
            MESSAGE=$(printf "ðŸš¨ *OPENING FOUND!*\n*Class:* %s\n*Days:* %s\n*Dates:* %s\n*Time:* %s\n*Spots Available:* %s\n*Link:* %s" \
              "$NAME" "$DOW" "$DATES" "$TIME" "$SPOTS_LEFT" "$DETAIL_URL")

            echo -e "Sending opening alert:\n$MESSAGE\n---"

            ENCODED_MESSAGE=$(echo "$MESSAGE" | jq -sRr @uri)

            # Fire the CallMeBot API Call
            curl -s -X GET "https://api.callmebot.com/whatsapp.php?phone=${{ secrets.WHATSAPP_PHONE_NUMBER_NOTIFY }}&text=${ENCODED_MESSAGE}&apikey=${{ secrets.CALLMEBOT_APIKEY }}"
          done
